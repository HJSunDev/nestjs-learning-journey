version: '3.8'
services:
  # === PostgreSQL 服务 ===
  postgres:
    # 镜像：使用官方 PostgreSQL 16 镜像（当前最新稳定版）
    image: postgres:16
    
    # 容器名称：带上项目前缀，避免与其他项目冲突 给运行起来的进程起个名，方便查找
    container_name: nest-journey-postgres
    
    # 自动重启：如果你重启电脑或 Docker，数据库会自动重新启动
    restart: always
    
    # 环境变量：设置初始的超级用户账号和默认数据库
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASS}
      POSTGRES_DB: ${DB_NAME}
    
    # 端口映射
    # 格式："宿主机端口:容器内部端口"
    # PostgreSQL 默认端口是 5432  将电脑的 5432 端口流量，通过网桥转发给容器内的 5432 端口
    ports:
      - "5432:5432"
    
    # 数据挂载 
    # 格式："宿主机路径:容器内部路径"
    # 作用：将容器里存数据的 /var/lib/postgresql/data 目录，直接映射到你当前项目下的 ./postgres-data 文件夹
    # 结果：你的数据实际上是存在你眼前的项目文件夹里的，而不是藏在 Docker 里的
    # PostgreSQL 数据目录是 /var/lib/postgresql/data
    volumes:
      - ./postgres-data:/var/lib/postgresql/data

  # === Redis 服务 ===
  redis:
    # 镜像：使用官方 Redis 7.2 版本 (目前较新的稳定版)
    image: redis:7.2
    
    # 容器名称
    container_name: nest-journey-redis
    
    # 自动重启
    restart: always
    
    # 启动命令：开启 AOF 持久化 (默认是关闭的，开启后数据更安全)
    # --requirepass 使用环境变量 ${REDIS_PASSWORD}
    # --maxmemory 512mb: 限制最大内存使用量
    # --maxmemory-policy allkeys-lru: 内存满时的淘汰策略
    command: redis-server --appendonly yes --requirepass "${REDIS_PASSWORD}" --maxmemory 512mb --maxmemory-policy allkeys-lru
    
    # 端口映射：宿主机 6379 -> 容器 6379
    ports:
      - "6379:6379"
    
    # 数据挂载：把 Redis 数据存在当前目录下的 ./redis-data 文件夹
    volumes:
      - ./redis-data:/data